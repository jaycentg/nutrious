{% extends 'base.html' %}
{% load static %}

<head>
    {% block meta %}
    <title>Food Sharing</title>
    <style>
        body {
            background-color: azure;
        }
    </style>
    {% endblock meta %}

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE-edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Food Sharing</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

</head>

{% block content %}

<body>
    {% if user.is_user %}
    <input id="current_user" value={{user.id}} type="hidden"></input>

    <nav class="navbar shadow navbar-expand-lg bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'home:show_index' %}">
                <img src="{% static 'NUTRIOUS.png' %}" alt="Logo" height="70" class="d-inline-block align-text-top">
            </a>
            <div class="d-flex flex-row">
                <button type="button" class="btn btn-outline-primary p-2 m-1" data-bs-toggle="modal"
                    data-bs-target="#Modal" id="modal-btn">Add Post</button>
                <div class="dropdown m-auto mx-3">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        Profile
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="{% url 'home:profile' %}">View Profile</a></li>
                        <li><a class="dropdown-item" href="{% url 'home:logout' %}">Log Out</a></li>
                    </ul>
                </div>

                
                {% if is_verified %}
                <img src="{{user_profile}}" class="rounded-circle shadow avatar m-auto mx-3 border border-success border-3">
                {% else %}
                <img src="{{user_profile}}" class="rounded-circle shadow avatar m-auto mx-3 border border-danger border-3">
                {% endif %}
            </div>
        </div>
    </nav>


    <div class="sharing d-flex align-items-center justify-content-center">
        <form class="sharing-form text-center" method="POST">
            {% csrf_token %}
            <br>
            <h1 class="text-uppercase">Info Sharing Food</h1>

            <p>User: {{user}}</p>

            <div class="modal" tabindex="-1" id="Modal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Location</h5>
                            <button id="close-modal" class="close">&times;</button>
                        </div>

                        <div class="modal-body">

                            <td>URL Image</td>
                            <td><input type="url" name="image" placeholder="Image" class="form-control"
                                    id="input_image"></td>

                            <td>Location</td>
                            <td><input type="text" name="location" placeholder="Location" class="form-control"
                                    id="input_location"></td>

                            <td>Description</td>
                            <td><input type="text" name="description" placeholder="Description"
                                    style="min-height: 100px" class="form-control" id="input_description"></td>

                        </div>

                        <div class="modal-footer">
                            <button id="create_post" class="btn button-custom rounded-pill" data-dismiss="modal">Add
                                Location</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal" tabindex="-1" id="edit-modal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Location</h5>
                            <button id="close-edit-modal" class="close">&times;</button>
                        </div>

                        <div class="modal-body">
                            <input type="hidden" name="" id="input_pk" value="">
                            <td>URL Image</td>
                            <td><input type="url" name="image" placeholder="Image" class="form-control"
                                    id="input_image_edit"></td>

                            <td>Location</td>
                            <td><input type="text" name="location" placeholder="Location" class="form-control"
                                    id="input_location_edit"></td>

                            <td>Description</td>
                            <td><input type="text" name="description" placeholder="Description"
                                    style="min-height: 100px" class="form-control" id="input_description_edit">
                            </td>

                        </div>

                        <div class="modal-footer">
                            <button id="edit_post" class="btn button-custom rounded-pill" data-dismiss="modal">Update
                                Post</button>
                        </div>
                    </div>
                </div>
            </div>

        </form>
    </div>

    <!-- <div class="container">
        <div class="card" id="card"></div>
    </div> -->
    {% else %}
    <nav class="navbar shadow navbar-expand-lg bg-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="{% url 'home:show_index' %}">
                <img src="{% static 'NUTRIOUS.png' %}" alt="Logo" height="70" class="d-inline-block align-text-top">
            </a>
            <div class="d-flex flex-row-reverse">
                <a class="btn btn-outline-primary p-2 m-3" role="button" href="{% url 'home:register' %}">Sign Up</a>
                <a class="btn btn-outline-success p-2 m-3" role="button" href="{% url 'home:login' %}">Log In</a>
            </div>
        </div>
    </nav>

    <div class="text-uppercase" style="text-align: center;">
        <br>
        <h1>Info Sharing Food</h1>

        <p>You have to log in to post location of food sharing</p>
    </div>

    {% endif %}

    <div class="container">
        <div class="card" id="card"></div>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>


    <script>
        function createCard() {
            console.log("masukkkk")
            console.log(`{{user}}`)
            $('#card').empty();
            let data_card = "";

            let button = "";
            $.get("json/", function (resp) {
                if (resp.length == 0) {
                    data_card = `<div class="p-4">
                        <div class="card mb-1 text-bg-light">
                                    <div class="card-body">
                                        <div class="col bg-light text-center">
                                        <h5 class="card-title">There is no post</h5>
                                        </div>
                                </div>
                            </div>
                        </div>
                    `

                }
                else {
                    for (let i of resp) {
                       
                        if (`{{user.is_user}}`) {
                            if (($("#current_user").val()) == `${i.fields.author}`) {
                                button = `<a data-id="${i.pk}" class="btn btn-outline-primary p-2 m-1" data-bs-toggle="modal"
                                            data-bs-target="#edit-modal" id="edit-modal-btn">Edit</a>
                                <a href="delete/${i.pk}" class="btn btn-outline-primary p-2 m-1">Delete</a>`

                            }
                        }
                        data_card += ` 
                    <div class="p-3">
                        <div class="card mb-3 text-bg-light">
                            <div class="row g-0">
                                <div class="col-md-4 bg-light text-center" style="width: md-4;">
                                    <img src=${i.fields.img}
                                        class="img-fluid rounded-start" style="width: 100%; height: 100%; object-fit: cover;">
                                        
                                </div>
                                <div class="col-md-8">
                                    <div class="card-body">
                                        <h5 class="card-title"><b>Locatian at:</b> ${i.fields.location}</h5>
                                        <p class="card-text"><b>Description : </b> ${i.fields.descripgtion}</p>
                                        <br>
                                     
                                        <p class="card-text"><small>Post Date: ${i.fields.date}</small></p>
                                        <p class="card-text"><small>Last Edit: ${i.fields.update_date}</small></p>
                                        
                                        ${button}
                                    </div>
                                <div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                    `


                    };
                }

                $('#card').append(data_card);



            })
        }

        $(document).ready(function () {
            var id = $(this).data;
            console.log(id)
            createCard();
            function validate() {
                if ($('#input_location').val().length > 0 &&
                    $('#input_description').val().length > 0 &&
                    $('#input_image').val().length > 0) {
                    $("#Send-footer").prop("disabled", false);
                }
                else {
                    $("#Send-footer").prop("disabled", true);
                }
            }

            $("#create_post").click(function (e) {
                console.log("ada masuk");
                var location = $("#input_location").val();
                var description = $("#input_description").val();
                var img = $("#input_image").val();
                validate();
                console.log(location)
                $.post("add_location/",
                    {
                        location,
                        description,
                        img,
                    },

                    function (data, status) {
                        createCard();
                        console.log("create card success");
                        $("#input_location").val("");
                        $("#input_description").val("");
                        $("#input_image").val("");
                        $('#Modal').modal('hide');
                    });

            });

            $("#edit_post").click(function (e) {

                console.log("ini kan");

                var pk = $("#input_pk").val();
                console.log(pk)

                var location = $("#input_location_edit").val();
                var description = $("#input_description_edit").val();
                var img = $("#input_image_edit").val();
                validate();
                console.log("ini kan yg edit", location)
                $.ajax({
                    url: `edit_add_save/${pk}`,
                    headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                    data: {
                        location,
                        description,
                        img,
                    },
                    method: "POST",
                    success: function (data, status) {
                        console.log("edit card success");
                        $("#input_location_edit").val("");
                        $("#input_description_edit").val("");
                        $("#input_image_edit").val("");
                        createCard();
                        $('#edit-modal').modal('hide');
                    },

                });

            });
        });

        $(document).on('click', '#edit-modal-btn', function (e) {
            e.preventDefault();
            edit_id = $(this).attr("data-id");
            $.ajax({
                url: `edit_add/${edit_id}`,
                method: "GET",

                success: function (data) {
                    data = JSON.parse(data);

                    $("#input_location_edit").val(data.location);
                    $("#input_description_edit").val(data.description);
                    $("#input_image_edit").val(data.img);
                    $("#input_pk").val(data.pk);
                    $('#edit-modal').modal('show');
                }
            })

        })

        $('#modal-btn').click(function (e) {
            e.preventDefault();
            console.log("ya masuk la")
            $('#Modal').modal();
        });

        // $('#edit-modal-btn').click(function (e) {
        // // $('[id^="edit-modal-btn"]').click(function (e) {
        //     e.preventDefault();
        //     $('#edit-modal').modal();
        //     console.log("uda panggil ya ges ya");
        //     var pk = $(this).data("data-id");
        //     console.log(pk);
        // });

        $('#close-modal').click(function (e) {
            e.preventDefault();
            $('#Modal').modal("hide");
        });

        $('#close-edit-modal').click(function (e) {
            e.preventDefault();
            $('#edit-modal').modal("hide");
        });


    </script>

</body>
<style>
    .avatar{
    width: 50px;
    height: 50px;
    object-fit: cover;
}
</style>
{% endblock content %}